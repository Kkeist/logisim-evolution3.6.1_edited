#
# Release workflow: build Windows (MSI) and macOS (DMG) and create GitHub Release.
# Trigger: push a tag v* (e.g. v3.6.1) or run manually (Actions → Release → Run workflow).
#
name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  prepare:
    name: Prepare
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.vars.outputs.version }}
      app_name: ${{ steps.vars.outputs.app_name }}
      tag_name: ${{ steps.vars.outputs.tag_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Set version and tag
        id: vars
        run: |
          app_name=$(grep '^name\s*=' gradle.properties | awk '{print $3}')
          version=$(grep '^version\s*=' gradle.properties | awk '{print $3}' | tr -d '-')
          if [ "${{ github.event_name }}" = "push" ]; then
            tag_name="${{ github.ref_name }}"
          else
            tag_name="v${version}"
          fi
          echo "app_name=${app_name}" >> "$GITHUB_OUTPUT"
          echo "version=${version}" >> "$GITHUB_OUTPUT"
          echo "tag_name=${tag_name}" >> "$GITHUB_OUTPUT"
          echo "Using tag: ${tag_name}"

  build_windows:
    name: Windows (MSI)
    runs-on: windows-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 14
        uses: actions/setup-java@v4
        with:
          java-version: '14'
          distribution: 'temurin'

      - name: Build MSI
        run: .\gradlew.bat createMsi -x checkstyleMain -x checkstyleTest

      - name: Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: windows-msi
          path: build/dist/${{ needs.prepare.outputs.app_name }}-${{ needs.prepare.outputs.version }}.msi

  build_macos:
    name: macOS (DMG)
    runs-on: macos-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 14
        uses: actions/setup-java@v4
        with:
          java-version: '14'
          distribution: 'temurin'

      - name: Build DMG
        run: |
          chmod +x gradlew
          ./gradlew createDmg -x checkstyleMain -x checkstyleTest

      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: build/dist/${{ needs.prepare.outputs.app_name }}-${{ needs.prepare.outputs.version }}.dmg

  build_jar:
    name: JAR (cross-platform)
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 14
        uses: actions/setup-java@v4
        with:
          java-version: '14'
          distribution: 'temurin'

      - name: Build JAR
        run: |
          chmod +x gradlew
          ./gradlew shadowJar -x checkstyleMain -x checkstyleTest

      - name: Upload JAR
        uses: actions/upload-artifact@v4
        with:
          name: jar
          path: build/libs/${{ needs.prepare.outputs.app_name }}-${{ needs.prepare.outputs.version }}-all.jar

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [prepare, build_windows, build_macos, build_jar]
    permissions:
      contents: write
    steps:
      - name: Download Windows MSI
        uses: actions/download-artifact@v4
        with:
          name: windows-msi

      - name: Download macOS DMG
        uses: actions/download-artifact@v4
        with:
          name: macos-dmg

      - name: Download JAR
        uses: actions/download-artifact@v4
        with:
          name: jar

      - name: Move artifacts to workspace root
        run: |
          mv windows-msi/build/dist/*.msi .
          mv macos-dmg/build/dist/*.dmg .
          mv jar/build/libs/*-all.jar .
          ls -la

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.tag_name }}
          name: Version ${{ needs.prepare.outputs.version }}
          draft: false
          generate_release_notes: true
          allow_updates: true
          files: |
            *.msi
            *.dmg
            *-all.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
